
// Enhanced client script for retention fields with default rate
frappe.ui.form.on('Sales Invoice', {
    setup: function(frm) {
        frm.retention_company_cache = {};
        frm.retention_rate_cache = {};
    },
    
    refresh: function(frm) {
        setup_retention_fields(frm);
    },
    
    company: function(frm) {
        // Clear cache when company changes
        frm.retention_company_cache = {};
        frm.retention_rate_cache = {};
        setup_retention_fields(frm);
    },
    
    custom_retention: function(frm) {
        calculate_retention_amount(frm);
    },
    
    base_net_total: function(frm) {
        calculate_retention_amount(frm);
    }
});

function setup_retention_fields(frm) {
    if (!frm.doc.company) {
        frm.toggle_display(['custom_retention', 'custom_retention_amount'], false);
        return;
    }
    
    const company_name = frm.doc.company;
    
    // Check cache first
    if (frm.retention_company_cache[company_name] !== undefined) {
        const is_enabled = frm.retention_company_cache[company_name];
        const default_rate = frm.retention_rate_cache[company_name];
        
        frm.toggle_display(['custom_retention', 'custom_retention_amount'], is_enabled);
        
        // Set default retention rate if field is empty and construction service is enabled
        if (is_enabled && !frm.doc.custom_retention && default_rate) {
            frm.set_value('custom_retention', default_rate);
        }
        
        console.log('✅ Using cached retention settings:', is_enabled, 'Default rate:', default_rate);
        return;
    }
    
    // Single API call to get both construction_service and default_retention_rate
    frappe.db.get_value('Company', company_name, ['construction_service', 'default_retention_rate'])
        .then(r => {
            const is_enabled = r.message.construction_service === 1;
            const default_rate = r.message.default_retention_rate || 5.0;
            
            // Cache the values
            frm.retention_company_cache[company_name] = is_enabled;
            frm.retention_rate_cache[company_name] = default_rate;
            
            // Toggle field visibility
            frm.toggle_display(['custom_retention', 'custom_retention_amount'], is_enabled);
            
            console.log('✅ Cached retention settings for', company_name, ':', is_enabled, 'Default rate:', default_rate);
            
            // Set default retention rate if field is empty and construction service is enabled
            if (is_enabled && !frm.doc.custom_retention) {
                frm.set_value('custom_retention', default_rate);
            }
            
            // Clear retention values if not enabled
            if (!is_enabled && frm.doc.custom_retention) {
                frm.set_value('custom_retention', 0);
                frm.set_value('custom_retention_amount', 0);
            }
        })
        .catch(err => {
            console.error('Error fetching company retention settings:', err);
        });
}

function calculate_retention_amount(frm) {
    if (frm.doc.custom_retention && frm.doc.base_net_total) {
        const retention_amount = (frm.doc.base_net_total * frm.doc.custom_retention) / 100;
        frm.set_value('custom_retention_amount', retention_amount);
    } else {
        frm.set_value('custom_retention_amount', 0);
    }
}
